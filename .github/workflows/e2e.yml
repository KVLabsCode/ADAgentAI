name: E2E Tests

on:
  push:
    branches: [main, DEV]
  pull_request:
    branches: [main, DEV]
  # Allow manual triggering
  workflow_dispatch:

env:
  CI: true
  PLAYWRIGHT_BASE_URL: http://localhost:3000

jobs:
  e2e:
    name: Playwright E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install frontend dependencies
        working-directory: frontend
        run: bun install

      - name: Install backend dependencies
        working-directory: backend
        run: |
          cd api && bun install
          cd .. && pip install -r requirements.txt

      - name: Install Playwright browsers
        working-directory: frontend
        run: bunx playwright install --with-deps chromium

      - name: Build frontend
        working-directory: frontend
        run: bun run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001

      - name: Start services
        run: |
          # Start API server
          cd backend/api && bun --hot src/index.ts &

          # Start frontend in production mode
          cd frontend && bun run start &

          # Wait for services to be ready
          bunx wait-on http://localhost:3000 http://localhost:3001 --timeout 120000
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BETTER_AUTH_SECRET: ${{ secrets.BETTER_AUTH_SECRET }}
          BETTER_AUTH_URL: http://localhost:3001
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          INTERNAL_API_KEY: ${{ secrets.INTERNAL_API_KEY }}

      - name: Run Playwright tests
        working-directory: frontend
        run: bunx playwright test
        env:
          PLAYWRIGHT_TEST_EMAIL: ${{ secrets.PLAYWRIGHT_TEST_EMAIL }}
          PLAYWRIGHT_TEST_PASSWORD: ${{ secrets.PLAYWRIGHT_TEST_PASSWORD }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-screenshots
          path: frontend/test-results/
          retention-days: 7
